// WoodLedger - Complete Prisma Schema
// MySQL Database for Furniture Business Management

generator client {
  provider   = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id           String   @id @default(cuid())
  name         String
  email        String   @unique
  passwordHash String   @map("password_hash")
  roleId       String   @map("role_id")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  role              Role               @relation(fields: [roleId], references: [id])
  sessions          Session[]
  notifications     Notification[]
  pushSubscriptions PushSubscription[]
  activityLogs      ActivityLog[]
  dashboardConfig   DashboardConfig?

  @@index([email])
  @@index([roleId])
  @@map("users")
}

// ============================================
// DASHBOARD CONFIGURATION
// ============================================

model DashboardConfig {
  id        String   @id @default(cuid())
  userId    String   @unique @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user    User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  widgets DashboardWidget[]

  @@map("dashboard_configs")
}

model DashboardWidget {
  id        String   @id @default(cuid())
  configId  String   @map("config_id")
  type      String // e.g., 'REVENUE_CHART', 'STATS_CARDS', 'ACTIVITY_FEED', etc.
  title     String?
  x         Int      @default(0) // Grid position
  y         Int      @default(0) // Grid position
  w         Int      @default(1) // Grid width
  h         Int      @default(1) // Grid height
  isVisible Boolean  @default(true) @map("is_visible")
  settings  Json? // Custom widget settings
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  config DashboardConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  @@index([configId])
  @@map("dashboard_widgets")
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  users           User[]
  rolePermissions RolePermission[]

  @@map("roles")
}

model Permission {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  module      String // e.g., 'orders', 'inventory', 'payments', 'users'
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  rolePermissions RolePermission[]

  @@index([module])
  @@map("permissions")
}

model RolePermission {
  id           String   @id @default(cuid())
  roleId       String   @map("role_id")
  permissionId String   @map("permission_id")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
  @@map("role_permissions")
}

model Session {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  token     String   @unique @db.VarChar(500)
  userAgent String?  @map("user_agent") @db.VarChar(500)
  ipAddress String?  @map("ip_address") @db.VarChar(45)
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("sessions")
}

// ============================================
// CLIENTS
// ============================================

model Client {
  id        String   @id @default(cuid())
  name      String
  phone     String
  email     String?
  address   String?  @db.Text
  notes     String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  orders   Order[]
  accounts Account[]

  @@index([name])
  @@index([phone])
  @@map("clients")
}

// ============================================
// FURNITURE & FABRIC TYPES
// ============================================

model FurnitureType {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  orderItems OrderItem[]
  stocks     Stock[]

  @@map("furniture_types")
}

model FabricType {
  id          String   @id @default(cuid())
  name        String   @unique
  imageUrl    String?  @map("image_url") @db.LongText
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  orderItems OrderItem[]
  stocks     Stock[]
  images     FabricImage[]

  @@map("fabric_types")
}

model FabricImage {
  id           String   @id @default(cuid())
  fabricTypeId String   @map("fabric_type_id")
  base64       String   @db.LongText
  isPrimary    Boolean  @default(false) @map("is_primary")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  fabricType FabricType @relation(fields: [fabricTypeId], references: [id], onDelete: Cascade)

  @@index([fabricTypeId])
  @@map("fabric_images")
}

// ============================================
// ORDERS
// ============================================

enum OrderStatus {
  PENDING
  CONFIRMED
  IN_PRODUCTION
  READY
  DELIVERED
  CANCELLED
}

model Order {
  id             String      @id @default(cuid())
  orderNumber    String      @unique @map("order_number")
  clientId       String      @map("client_id")
  totalPrice     Decimal     @map("total_price") @db.Decimal(12, 2)
  advancePayment Decimal     @default(0) @map("advance_payment") @db.Decimal(12, 2)
  deliveryDate   DateTime?   @map("delivery_date")
  status         OrderStatus @default(PENDING)
  notes          String?     @db.Text
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @updatedAt @map("updated_at")

  // Relations
  client   Client      @relation(fields: [clientId], references: [id])
  items    OrderItem[]
  payments Payment[]

  @@index([clientId])
  @@index([status])
  @@index([deliveryDate])
  @@index([orderNumber])
  @@map("orders")
}

model OrderItem {
  id              String  @id @default(cuid())
  orderId         String  @map("order_id")
  furnitureTypeId String  @map("furniture_type_id")
  quantity        Int     @default(1)
  price           Decimal @db.Decimal(12, 2)
  notes           String? @db.Text

  // Relations
  order         Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  furnitureType FurnitureType @relation(fields: [furnitureTypeId], references: [id])
  fabricTypes   FabricType[]

  @@index([orderId])
  @@index([furnitureTypeId])
  @@map("order_items")
}

// ============================================
// INVENTORY / STOCK
// ============================================

model Stock {
  id              String   @id @default(cuid())
  productName     String   @map("product_name")
  furnitureTypeId String   @map("furniture_type_id")
  fabricTypeId    String   @map("fabric_type_id")
  quantity        Int      @default(0)
  minQuantity     Int      @default(5) @map("min_quantity") // For low stock alerts
  createPrice     Decimal  @map("create_price") @db.Decimal(12, 2)
  sellingPrice    Decimal  @map("selling_price") @db.Decimal(12, 2)
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  furnitureType FurnitureType @relation(fields: [furnitureTypeId], references: [id])
  fabricType    FabricType    @relation(fields: [fabricTypeId], references: [id])
  images        StockImage[]

  @@unique([furnitureTypeId, fabricTypeId])
  @@index([productName])
  @@index([quantity])
  @@map("stock")
}

model StockImage {
  id        String   @id @default(cuid())
  stockId   String   @map("stock_id")
  base64    String   @db.LongText
  isPrimary Boolean  @default(false) @map("is_primary")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  stock Stock @relation(fields: [stockId], references: [id], onDelete: Cascade)

  @@index([stockId])
  @@map("stock_images")
}

// ============================================
// ACCOUNTS & PAYMENTS
// ============================================

enum AccountType {
  CLIENT
  VENDOR
  LABOR
  EXPENSE
  OTHER
}

model Account {
  id        String      @id @default(cuid())
  name      String
  type      AccountType
  clientId  String?     @map("client_id")
  balance   Decimal     @default(0) @db.Decimal(12, 2)
  details   String?     @db.Text
  createdAt DateTime    @default(now()) @map("created_at")
  updatedAt DateTime    @updatedAt @map("updated_at")

  // Relations
  client   Client?   @relation(fields: [clientId], references: [id])
  payments Payment[]

  @@index([type])
  @@index([clientId])
  @@map("accounts")
}

enum PaymentType {
  CREDIT // Money received
  DEBIT // Money paid out
}

model Payment {
  id          String      @id @default(cuid())
  accountId   String      @map("account_id")
  orderId     String?     @map("order_id")
  amount      Decimal     @db.Decimal(12, 2)
  type        PaymentType
  description String?
  date        DateTime    @default(now())
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  // Relations
  account Account @relation(fields: [accountId], references: [id])
  order   Order?  @relation(fields: [orderId], references: [id])

  @@index([accountId])
  @@index([orderId])
  @@index([date])
  @@index([type])
  @@map("payments")
}

// ============================================
// NOTIFICATIONS
// ============================================

enum NotificationType {
  ORDER
  PAYMENT
  STOCK
  DELIVERY
  SYSTEM
}

enum NotificationStatus {
  UNREAD
  READ
  ARCHIVED
}

model Notification {
  id        String             @id @default(cuid())
  userId    String             @map("user_id")
  type      NotificationType
  title     String
  content   String             @db.Text
  status    NotificationStatus @default(UNREAD)
  link      String?            @db.VarChar(500)
  createdAt DateTime           @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("notifications")
}

// ============================================
// ACTIVITY LOGS (Audit Trail)
// ============================================

model ActivityLog {
  id         String   @id @default(cuid())
  userId     String?  @map("user_id")
  action     String // e.g., 'CREATE', 'UPDATE', 'DELETE', 'LOGIN', 'LOGOUT'
  entityType String   @map("entity_type") // e.g., 'Order', 'Payment', 'User'
  entityId   String?  @map("entity_id")
  details    Json? // Additional context about the action
  ipAddress  String?  @map("ip_address") @db.VarChar(45)
  userAgent  String?  @map("user_agent") @db.VarChar(500)
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
  @@index([entityType])
  @@index([createdAt])
  @@map("activity_logs")
}

// ============================================
// PUSH NOTIFICATIONS
// ============================================

model PushSubscription {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  endpoint  String   @db.Text
  p256dh    String   @db.Text
  auth      String   @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("push_subscriptions")
}
